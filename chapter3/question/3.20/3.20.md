# プログラミング演習3.20  
## 課題内容  
ユーザー名かユーザーIDと任意の個数のファイル名をコマンド行で、指定できる単純版のchownを書きなさい。  
ユーザー名をユーザーIDに変換するためにはどうすればよいか答えなさい。  
システムに指定されたユーザー名をもつユーザーがいなければ、どうするか。  
注意：書いたプログラムをテストするには、スーパーユーザーにならなければならない。  
  
## chownの仕様を確認  
文法は以下の通り  
  
```  
$ chown [username or userId] FILE1 , FILE2 , FILE3 ...  
```  
  
これでユーザーネームやユーザーIDを指定されたものに変更する。  
  
## ファイルのユーザーIDやユーザー名を指定するにはどうすればいいのか?  
  
chownシステムコールを使う。  
  
```  
#include <unistd.h>  
int chown(char *path, uid_t owner , gid_t group);  
```  
  
例えば   
chown("file1", 200 , 40);  
  
はfile1のユーザーIDを200 , グループIDを40に変更する。  
引数として-1を指定した場合、その属性は変更されない。  
  
スーパーユーザー以外のユーザーがこのシステムコールを呼んだ場合、  
chown : Operation not permittedとなりエラーとなる。  
  
システムに指定されたユーザー名をもつユーザーがいなければ、  
指定されたユーザーは存在しないとエラーを返して、終了させればよい。  
  
  
## 実装してみた  
  
### ソースコード  
```  
#include <ctype.h>  
#include <pwd.h>  
#include <stdio.h>  
#include <stdlib.h>  
#include <sys/types.h>  
#include <unistd.h>  
  
int is_all_digits(const char *s) {  
  for (size_t i = 0; s[i] != '\0'; i++) {  
    if (!isdigit((unsigned char)s[i]))  
      return 0;  
  }  
  return 1;  
}  
  
int main(int ac, char *av[]) {  
  struct passwd *user_passwd;  
  uid_t user;  
  
  if (ac < 3) {  
    fprintf(stderr, "引数が足りません\n");  
    return 1;  
  } else {  
    if (is_all_digits(av[1])) {  
      user = atoi(av[1]);  
    } else {  
      if ((user_passwd = getpwnam(av[1])) == NULL) {  
        fprintf(stderr, "入力されたユーザー名は存在しません。\n");  
        return 1;  
      } else {  
        user = user_passwd->pw_uid;  
      }  
    }  
  
    for (int i = 2; i < ac; i++) {  
      if (chown(av[i], user, -1) == -1) {  
        perror(av[i]);  
      }  
    }  
  }  
}  
```  
  
### 実行結果  
```  
$ ls -l  
total 24  
-rw-r--r-- 1 taichi84 taichi84  2135 Sep  2 23:01 3.20.md  
-rwxr-xr-x 1 taichi84 taichi84 16304 Sep  2 23:01 chown1  
-rw-r--r-- 1 taichi84 taichi84   843 Sep  2 23:01 chown1.c  
-rw-r--r-- 1 kickme   taichi84     0 Sep  2 22:06 test  
-rw-r--r-- 1 kickme   taichi84     0 Sep  2 22:39 test2  
-rw-r--r-- 1 kickme   taichi84     0 Sep  2 22:39 test3  
  
$ sudo ./chown1 taichi84 test test2 test3  
$ ls -l  
  
total 24  
-rw-r--r-- 1 taichi84 taichi84  2135 Sep  2 23:01 3.20.md  
-rwxr-xr-x 1 taichi84 taichi84 16304 Sep  2 23:01 chown1  
-rw-r--r-- 1 taichi84 taichi84   843 Sep  2 23:01 chown1.c  
-rw-r--r-- 1 taichi84 taichi84     0 Sep  2 22:06 test  
-rw-r--r-- 1 taichi84 taichi84     0 Sep  2 22:39 test2  
-rw-r--r-- 1 taichi84 taichi84     0 Sep  2 22:39 test3$ ls -l  
  
```  
  
