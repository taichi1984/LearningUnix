# 研究課題7.5
## 課題内容
タイマのインターバルがmove_msgの実行時間より短いと、bounce1d.cにとのような効果が現れるかを議論しなさい。
変数posはどうなるのか、画面はどうなるのか。再帰とブロックの両方の実装について、これらの問いに答えなさい。
データを壊さずにシグナルも失わない方法はあるか。

## bounce1dのコード

```
#include <curses.h>
#include <signal.h>
#include <stdio.h>
#include <string.h>

/* mainとハンドラが使うグローバル設定 */

#define MESSAGE "hello"
#define BLANK "     "
int set_ticker(int n_msecs);

int row; // 現在の行
int col; // 現在の列
int dir; // 現在の方向

int main() {
  int delay;          /* 大きければ大きいほど遅い */
  int ndelay;         /*新しい遅延*/
  int c;              /*ユーザー入力*/
  void move_msg(int); /*タイマハンドラ*/

  initscr();
  crmode();
  noecho();
  clear();

  row = 10;
  col = 0;
  dir = 1;
  delay = 200;

  move(row, col);
  addstr(MESSAGE);
  signal(SIGALRM, move_msg);
  set_ticker(delay);

  while (1) {
    ndelay = 0;
    c = getch();
    if (c == 'Q')
      break;
    if (c == ' ')
      dir = -dir;
    if (c == 'f' && delay > 2)
      ndelay = delay / 2;
    if (c == 's')
      ndelay = delay * 2;
    if (ndelay > 0)
      set_ticker(delay = ndelay);
  }
  endwin();
  return 0;
}

void move_msg(int signum) {
  signal(SIGALRM, move_msg);
  move(row, col);
  addstr(BLANK);
  col += dir;
  move(row, col);
  addstr(MESSAGE);
  refresh();

  /*
   *  境界条件を処理する
   */

  if (dir == -1 && col <= 0)
    dir = 1;
  else if (dir == 1 && col + strlen(MESSAGE) >= COLS)
    dir = -1;
}
```
## タイマのインターバルがmove_msgの実行時間よりも短いと、どのような効果が現れるか？
### ブロックの場合 
move_msgのほうが長い時間がかかっていた場合、move_msgの実行時間にあわせて画面が更新されるようになる。
move_msgの実行に時間がかかる場合、move_msgの実行が終わるまでは本スレッドはブロックされてハンドルの処理が終わるのを待つので、
move_msgの実行にあわせて画面が描画されるようになる。
複数のシグナルをブロックすることはできないので、基本的に２個目以上のブロックできるシグナルが来た場合、２個目以降は捨てられる。


### 再入の場合
基本的にsignalでシグナルを呼んだ場合、sigactionではないので、ブロックされる動作を変えることが出来ないが、sigactionで再入可能に変えたと仮定する。
move_msgの処理が終わるまでにmove_msgが呼ばれることになるため、どこの処理まで進んでいたかにもよるが、おそらくrowやcolなどの位置関係の変数は変更されたまま、
画面がrefresh()されずに、更に呼ばれるようになると思われる。
画面が止まった状態になり、move_msgが終わらないうちにさらにmove_msgが呼ばれてしまうので、無限にmove_msgが終わらない形になると思われる。
表示は最後まで行われないよ雨になるのではないかと思われる。
仮に途中で何らかの方法で処理が最後までいったとしても、間が一気に抜けてrowとcolが一気に増えるため、文字列が一気にワープしたような動きになるはずである。

## データを失わないようにするには
再入をしないでブロックするようにすればデータは壊れない。
データを壊さずにシグナルも失わないようにすることは基本的にハンドラの実行時間がのほうが長いとできないと思われる。
ゆえにハンドラは実際の描画処理とかを書かずに、数値だけ動かしてタイマの時間より必ず早く終わる軽い処理を書くのが理想的と思われる。





