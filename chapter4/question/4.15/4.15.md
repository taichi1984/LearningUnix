# プログラミング課題 4.15  
  
## 課題内容  
Unixのmkdirコマンドには-pオプションがある。このオプションをサポートするmkdirを書きなさい。  
  
## mkdir のmanページを確認。mkdirの動きや形式と-p　オプションの内容を確認する。  
### mkdirのmanページの内容  
  
名前  
       mkdir - ディレクトリを作成する  
  
書式  
       mkdir [OPTION]... DIRECTORY...  
  
説明  
       ディレクトリが存在しない場合に、ディレクトリを作成します。  
  
       長いオプションで必須となっている引数は短いオプションでも必須です。  
  
       -p, --parents  
              ディレクトリが存在していてもエラーを返さない。必要に応じて親ディレクトリを作成する  
  
### 機能要点まとめ  
ディレクトリが存在しない場合にディレクトリを作成するのが基本機能  
-p オプションを指定する場合、ディレクトリが存在しない場合にもエラーを返さないで必要に応じて親ディレクトリを作成する。  
  
## mkdirシステムコール  
ディレクトリを作成するシステムコール  
  
### インクルード  
```  
#include<sys/stat.h>  
#include<sys/types.h>  
```  
  
### 書式  
int result = mkdir(char *pathname,mode_t mode);  
  
### 引数  
pathname : 新しいディレクトリの名前  
mode パーミッションビットのためのマスク  
  
### 戻り値  
-1 : エラーの時  
0  : 成功したとき  
  
## mkdirシステムコールを使って mkdir -pが実装されている mkdir1.cを書く  
ソースコードは以下の通り  
  
```  
  
#define _POSIX_C_SOURCE 200809L  
#include <errno.h>  
#include <limits.h>  
#include <stdio.h>  
#include <stdlib.h>  
#include <string.h>  
#include <sys/stat.h>  
#include <sys/types.h>  
#include <unistd.h>  
  
typedef struct {  
  int option_p;  
  
} Options;  
  
int do_mkdir(char *filepath, Options option) {  
  
  int n = 0;  
  char *path_list[255];  
  
  if (option.option_p == 1) {  
    path_list[n] = strtok(filepath, "/");  
    if (mkdir(path_list[n], S_IRUSR | S_IWUSR | S_IXUSR | S_IXGRP | S_IXOTH) !=
        0) {  
      if (errno == EEXIST) {  
  
      } else {  
        perror("mkdir");  
        return -1;  
      }  
    }  
  
    n++;  
  
    while ((path_list[n] = strtok(NULL, "/")) != NULL) {  
      char dir_path[PATH_MAX] = "";  
      for (int i = 0; i <= n; i++) {  
        if (i > 0)  
          strncat(dir_path, "/", sizeof(dir_path) - strlen(dir_path) - 1);  
        strncat(dir_path, path_list[i],  
                sizeof(dir_path) - strlen(dir_path) - 1);  
      }  
      // printf("dirpath : %s \n", dir_path);  
      if (mkdir(dir_path, S_IRUSR | S_IWUSR | S_IXUSR | S_IXGRP | S_IXOTH) !=
          0) {  
        if (errno == EEXIST) {  
  
        } else {  
          perror("mkdir");  
          return -1;  
        }  
      }  
      n++;  
    }  
  } else {  
    if (mkdir(filepath, S_IRUSR | S_IWUSR | S_IXUSR | S_IXGRP | S_IXOTH) != 0) {
      perror("mkdir");  
      exit(1);  
    }  
  }  
  return 0;  
}  
  
int main(int ac, char *av[]) {  
  
  Options option = {0};  
  int file_argc = 0;  
  
  for (int i = 1; i < ac; i++) {  
  
    if (av[i][0] == '-') {  
      if (strcmp(av[i], "-p") == 0) {  
        option.option_p = 1;  
      } else {  
        fprintf(stderr, "Unknown option: %s\n", av[i]);  
      }  
    } else {  
      do_mkdir(av[i], option);  
      file_argc++;  
    }  
  }  
  
  if (file_argc == 0) {  
    printf("ディレクトリを正しく指定してください \n");  
  }  
  
  return 0;  
}  
```  
  
## 実行結果  
```  
$ ls  
4.15.md  mkdir1  mkdir1.c  
  
$ ./mkdir1 -p abc/def/ghi xyz/jkl/acd abc/olp  
$ tree  
.  
├── 4.15.md  
├── abc  
│   ├── def  
│   │   └── ghi  
│   └── olp  
├── mkdir1  
├── mkdir1.c  
└── xyz  
    └── jkl  
        └── acd  
  
7 directories, 3 files  
```  
  
上手く実行できているようだ。  
