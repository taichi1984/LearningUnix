From 14fcd7b412a7a13973a9453fd97f60fc277ebd0f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Christian=20G=C3=B6ttsche?= <cgzones@googlemail.com>
Date: Fri, 5 Aug 2022 17:57:26 +0200
Subject: [PATCH] Fail if regular file pre-exists in copy_tree()

Similar to the default behavior of mkdir(2), symlink(2), link(2) and
mknod(2).
---
 libmisc/copydir.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: shadow-4.2/libmisc/copydir.c
===================================================================
--- shadow-4.2.orig/libmisc/copydir.c
+++ shadow-4.2/libmisc/copydir.c
@@ -742,7 +742,7 @@ static int copy_file (const char *src, c
 		return -1;
 	}
 #endif				/* WITH_SELINUX */
-	ofd = open (dst, O_WRONLY | O_CREAT | O_TRUNC | O_NOFOLLOW, statp->st_mode & 07777);
+	ofd = open (dst, O_WRONLY | O_CREAT | O_EXCL | O_TRUNC | O_NOFOLLOW | O_CLOEXEC, statp->st_mode & 07777);
 	if (   (ofd < 0)
 	    || (fchown_if_needed (ofd, statp,
 	                          old_uid, new_uid, old_gid, new_gid) != 0)
