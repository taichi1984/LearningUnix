# プログラミング課題7.15
## 課題内容
**usleep()によるブロックと入力処理** bounce1d.cでは、メインループはgetch呼び出しでブロックされ、アニメーションはシグナルハンドラで処理していた。
hello5.cをもとにして、ユーザー入力と、アニメーションの役割を逆にした、新しいバージョンのbounce1d.cを書きなさい。
この新バージョンでは、メインループはusleep()呼び出しでブロックされ、ユーザー入力はシグナルハンドラで処理するものとする。


## bounce1d.cのソースコード
```
#include <curses.h>
#include <signal.h>
#include <string.h>

/* mainとハンドラが使うグローバル設定 */

#define MESSAGE "hello"
#define BLANK "     "
int set_ticker(int n_msecs);

int row; // 現在の行
int col; // 現在の列
int dir; // 現在の方向

int main() {
  int delay;          /* 大きければ大きいほど遅い */
  int ndelay;         /*新しい遅延*/
  int c;              /*ユーザー入力*/
  void move_msg(int); /*タイマハンドラ*/

  initscr();
  crmode();
  noecho();
  clear();

  row = 10;
  col = 0;
  dir = 1;
  delay = 200;

  move(row, col);
  addstr(MESSAGE);
  signal(SIGALRM, move_msg);
  set_ticker(delay);

  while (1) {
    ndelay = 0;
    c = getch();
    if (c == 'Q')
      break;
    if (c == ' ')
      dir = -dir;
    if (c == 'f' && delay > 2)
      ndelay = delay / 2;
    if (c == 's')
      ndelay = delay * 2;
    if (ndelay > 0)
      set_ticker(delay = ndelay);
  }
  endwin();
  return 0;
}

void move_msg(int signum) {
  signal(SIGALRM, move_msg);
  move(row, col);
  addstr(BLANK);
  col += dir;
  move(row, col);
  addstr(MESSAGE);
  refresh();

  /*
   *  境界条件を処理する
   */

  if (dir == -1 && col <= 0)
    dir = 1;
  else if (dir == 1 && col + strlen(MESSAGE) >= COLS)
    dir = -1;
}

```

このプログラムではアニメーションの管理にset_ticker.cを使って、時間ごとに割り込み処理を行い描画を行うようにしている。

## hello5.cのソースコード

```
/* hello5.c
 * 目的: メッセージを画面内で跳ね返らせる。
 * 概要: 初期化、描画、入力待ち、終了
 */

#include <curses.h>
#include <stdio.h>
#include <unistd.h>

#define LEFTEDGE 10
#define RIGHTEDGE 30
#define ROW 10

int main() {
  char message[] = "Hello";
  char blank[] = "     ";
  int dir = +1;
  int pos = LEFTEDGE;

  initscr();
  clear();

  while (1) {
    move(ROW, pos);
    addstr(message);
    move(LINES - 1, COLS - 1);
    refresh();
    usleep(20000);
    move(ROW, pos);
    addstr(blank);
    pos += dir;
    if (pos >= RIGHTEDGE)
      dir = -1;
    if (pos <= LEFTEDGE)
      dir = +1;
  }
}
```

これを参考に作ることになる。
メイン関数でsleepを使い、ループの速さを調整している。

## 新しく作ったbounce1d_2.col

```

#include <curses.h>
#include <fcntl.h>
#include <signal.h>
#include <unistd.h>

/* mainとハンドラが使うグローバル設定 */

#define MESSAGE "hello"
#define BLANK "     "
#define LEFTEDGE 10
#define RIGHTEDGE 100
#define ROW 10

int dir = +1;
int main() {

  int pos = LEFTEDGE;
  int fd = STDIN_FILENO;
  void change_dir(int signum);

  fcntl(fd, F_SETOWN, getpid());
  fcntl(fd, F_SETFL, O_ASYNC | O_NONBLOCK);

  initscr();
  crmode();
  noecho();
  clear();

  signal(SIGIO, change_dir);

  while (1) {
    move(ROW, pos);
    addstr(MESSAGE);
    refresh();
    usleep(20000);
    move(ROW, pos);
    addstr(BLANK);

    pos += dir;

    if (pos >= RIGHTEDGE)
      dir = -1;
    if (pos <= LEFTEDGE)
      dir = +1;
  }

  endwin();
  return 0;
}

void change_dir(int signum) {
  char key;
  read(STDIN_FILENO, &key, 1);
  if (key == ' ') {
    dir = -dir;
  }
}

```

SIGIOシグナルが発生したらchange_dirを呼ぶようになっている。
スペースが押されたときのみdirを-dirにすることで、向きの変更を行っている。

## 実行結果
スペースを押したときのみ方向が変更できるようになった。
目的の仕様は満たしているようだ。

