# 第４章で学ぶシステムコール  
  
## mkdir  
  
### 目的  
ディレクトリを作成する。  
  
### インクルード  
```  
#include<sys/stat.h>  
#include<sys/types.h>  
```  
  
### 書式  
```  
int result = mkdir(char *pathname, mode_t mode);  
```  
  
### 引数  
pathname : 新しいディレクトリの名前  
mode     : パーミッションビットの溜めのマスク  
  
### 戻り値  
-1 : エラーの時  
0  : 成功したとき  
  
### 内部の動き  
mkdirは、新しいディレクトリを作成し、ファイルシステムツリーにディレクトリのノードをリンクする。  
つまり、mkdirはディレクトリのためのinodeを作成し、その内容のためのディスクブロックを確保し、  
ディレクトリ内に正しいinode番号がセットされた"." と".."のための２個のエントリを作り、親ディレクトリにそのノードへのリンクを追加する。  
  
  
## rmdir  
### 目的  
ディレクトリを削除する。ディレクトリは空でなければいけない。  
  
### インクルード  
```  
#include<unistd.h>  
```  
  
### 書式  
```  
int result = rmdir(const char *path);  
```  
  
### 引数  
path  : ディレクトリの名前  
  
### 戻り値  
-1 : エラーの時  
0  : 成功したとき  
  
### 内部の動き  
rmdirは、ディレクトリツリーからディレクトリノードを削除する。ディレクトリは空でなければならない。  
つまり、".",".."のためのエントリ以外にファイルやディレクトリが含まれていてはならない。  
親ディレクトリからは、このディレクトリに対するリンクが削除される。  
ディレクトリ自体が他のプロセスによって使われているのでなければ、inodeとデータブロックは解放される。  
  
## unlink  
### 目的  
ディレクトリエントリを削除する。  
  
### インクルード  
```  
#include<unistd.h>  
```  
  
### 書式  
```  
int result = unlink(const char *path);  
```  
  
### 引数  
```  
path : 削除するディレクトリエントリの名前  
```  
  
### 戻り値  
-1 : エラーの時  
0  : 成功したとき  
  
### rmコマンドとの関連  
rmコマンドは、ディレクトリからエントリを削除するコマンドだが、コマンド行引数として、１つ以上のファイル名を受け付ける。  
rmコマンドは、unlinkシステムコールを使って、ファイルを削除する。  
  
### 内部の動き  
 unlinkはディレクトリエントリを削除する。対応するinodeのリンク数をデクリメントする。  
inodeのリンク数が０になると、データブロックと、inodeは解放される。  
inodeに対して他にリンクがある場合は、データブロックやinodeは残される。  
  
### 注意点  
unlinkはディレクトリのアンリンクのために使ってはならない。  
  
## link  
### 目的  
ファイルに対する新しいリンクを作成する。  
  
### インクルード  
```  
#include<unistd.h>  
```  
  
### 書式  
```  
int result = link(const char *orig, const char *new);  
```  
  
### 引数  
orig : 元のリンクの名前  
new  : 新しいリンクの名前  
  
### 戻り値  
失敗したとき : -1  
成功したとき : 0  
  
### lnコマンドとの関係  
lnコマンドはファイルへのリンクを作成するが、lnコマンドは、linkシステムコールを使っている。  
  
linkは、inodeに対する新しいリンクを作成する。  
新しいリンクは、元のリンクと同じinode番号と新しく指定された名前を持つ。つけようとした名前が既にリンクとして使われている場合、linkは失敗する。  
linkを使ってディレクトリに対する新しいリンクを作ることは認められていない。  
  
  
## rename  
### 目的  
リンクの名前の変更、または移動。  
  
### 書式  
```  
int result = rename(const char *from , const char *to);  
```  
  
### 引数  
from : 元のリンクの名前  
to   : 新しいリンクの名前  
  
### 戻り値  
-1 : エラーの時  
0  : 成功したとき  
  
### mv コマンドとの関係  
mvコマンドは、ファイルやディレクトリの名前や位置を変更する。  
多くの場合は、mvは単純にrenameシステムコールを使っているだけである。  
  
### 注意点  
renameは元ディレクトリをサブディレクトリのどれかに移動することを禁止している。（無限循環が起こるため)  
  
### 内部の動き  
renameはどんな仕組みでファイルを他のディレクトリに移動するのか？  
ディレクトリにはファイルはなく、あるのはファイルへのリンクである。  
renameはリンクをもとのディレクトリから別のディレクトリに移動する。  
基本的な仕組みは  
```  
元のリンクを新しい名前、位置にコピーし  
元のリンクを削除する  
```  
  
という仕組みになっている。  
Unixではこれらの処理を実行するlinkとunlinkの３つのシステムコールを提供している。  
そのため、rename("x","z");は  
  
```  
if(link ("x","z") != -1)  
    unlink("x");  
```  
  
という動作になる。  
  
## chdir  
### 目的  
呼び出し元プロセスのカレントディレクトリを変更する。  
  
### インクルード  
```  
#include <unistd.h>  
```  
  
### 書式  
  
int result = chdir(const char *path);  
  
### 引数  
path : 新ディレクトリのパス  
  
### 戻り値  
-1 : エラー時  
0  : 成功したとき  
  
### cdコマンドとの関係  
cdコマンドは、プロセスのカレントディレクトリを変更する。  
cdが影響を与えるのはプロセスでディレクトリではない。  
cdはchdirシステムコールを使う。  
  
  
### 内部の仕組み  
Unixで実行されているプログラムは、それぞれカレントディレクトリを持つ。  
chdirシステムコールは、プロセスのカレントディレクトリを変更する。  
プロセスは今、"そのディレクト"にある。  
  
システムで実際に行われていることを見ると、プロセスはカレントディレクトリのinode番号を格納する変数を管理している。  
"新しいディレクトリに移動した、というとき、実際にはその変数の値を書き換えているだけである。  
  
  
  
  
