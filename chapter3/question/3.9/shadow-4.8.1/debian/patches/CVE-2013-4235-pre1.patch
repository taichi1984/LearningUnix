From b4472167c2f5057d56686d3349a9b55fc508efe6 Mon Sep 17 00:00:00 2001
From: ed neville <ed@s5h.net>
Date: Fri, 31 Dec 2021 22:40:13 +0000
Subject: [PATCH] Adding nofollow to opens

---
 libmisc/copydir.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

Index: shadow-4.2/libmisc/copydir.c
===================================================================
--- shadow-4.2.orig/libmisc/copydir.c
+++ shadow-4.2/libmisc/copydir.c
@@ -739,7 +739,7 @@ static int copy_file (const char *src, c
 	char buf[1024];
 	ssize_t cnt;
 
-	ifd = open (src, O_RDONLY);
+	ifd = open (src, O_RDONLY|O_NOFOLLOW);
 	if (ifd < 0) {
 		return -1;
 	}
@@ -748,7 +748,7 @@ static int copy_file (const char *src, c
 		return -1;
 	}
 #endif				/* WITH_SELINUX */
-	ofd = open (dst, O_WRONLY | O_CREAT | O_TRUNC, statp->st_mode & 07777);
+	ofd = open (dst, O_WRONLY | O_CREAT | O_TRUNC | O_NOFOLLOW, statp->st_mode & 07777);
 	if (   (ofd < 0)
 	    || (fchown_if_needed (ofd, statp,
 	                          old_uid, new_uid, old_gid, new_gid) != 0)
