# 研究課題5.03  
## 課題内容  
**ディレクトリ操作とデバイスファイル**  この章ではデバイスファイルのファイル入出力処理がどのような仕組みになっているかを見てきた。  
ln,mv,rmなどのディレクトリ処理はどうだろうか。図5-1を使ってこれら３つのコマンドがディレクトリ、inode、ドライバにどのような影響を与えるか説明しなさい。  
  
## 図 5-1について  
本文の202ページを参照。  
本レポートでは実際に起こる内容をテキストベースで説明していく。  
  
## デバイスファイルに対するディレクトリ処理  
### lnコマンド  
```  
$ ln /dev/pts/1 testtty  
ln: 'testtty' から '/dev/pts/1' へのハードリンクの作成に失敗しました: 無効なクロスデバイスリンクです  
```  
デバイスファイルに対するハードリンクの作成は許可されていないようだ。  
ハードリンクの作成によってディレクトリ、inode、ドライバに影響を与えることはできない。  
  
```  
$ ln -s /dev/pts/1 testtty  
$ ls  
5.03.md  testtty  
```  
シンボリックリンクについては作成することが可能。  
シンボリックリンクは、ハードリンクと違い、違うinodeをもつ新しいファイルを作成する。  
そのinodeには指定したパス文字列が格納されており、それを解決してもとのファイルを参照するショートカットであるため、ディレクトリにシンボリックリンクを作成することは可能だが、デバイスファイルのinodeには影響を与えない。  
  
```  
$ cat testtty  
test abc  
test abc  
test def  
test def  
```  
作成したシンボリックリンクに対してcatをしたりすると、対象のデバイスファイルに対してcatを実行することは可能。  
  
### mvコマンド  
```  
$ sudo mv /dev/  
pts/1 .  
mv: '/dev/pts/1' を削除できません: 許可されていない操作です  
$ ls  
1  5.03.md  testtty  
```  
デバイスファイルに対するmvコマンドは実際にはもとのファイルが削除されることはないが、複製した処理までは実行されてしまうので、移動先に新しい端末ファイルが作成される。  
これに対してcatをしようとすると、以下のようなエラーが出る。  
  
```  
$ cat 1  
cat: 1: 入力/出力エラーです  
```  
/dev/pts/1の複製を作ったはずなのに、なぜこのファイルに対してcatができないのだろうか？  
両ファイルをstatして内容を比べてみる。  
  
```  
$ stat /dev/pts/1  
  File: /dev/pts/1  
  Size: 0               Blocks: 0          IO Block: 1024   キャラクタスペシャルファイル  
Device: 0,26    Inode: 4           Links: 1     Device type: 136,1  
Access: (0620/crw--w----)  Uid: ( 1000/taichi84)   Gid: (    5/     tty)  
Access: 2025-09-28 14:28:25.000000000 +0900  
Modify: 2025-09-28 14:28:25.000000000 +0900  
Change: 2025-09-28 14:08:56.277816913 +0900  
 Birth: -  
  
$ stat 1  
  File: 1  
  Size: 0               Blocks: 0          IO Block: 4096   キャラクタスペシャルファイル  
Device: 259,2   Inode: 39994295    Links: 1     Device type: 136,1  
Access: (0620/crw--w----)  Uid: ( 1000/taichi84)   Gid: (    5/     tty)  
Access: 2025-09-28 14:21:20.000000000 +0900  
Modify: 2025-09-28 14:21:20.000000000 +0900  
Change: 2025-09-28 14:21:27.061715924 +0900  
 Birth: 2025-09-28 14:21:27.061715924 +0900  
```  
  
これらの２つのファイルを見比べてわかるのは、まずIO Blockの値が違うこと。  
これに関しては、そもそも端末デバイスはIOStreamとなっており、IO Blockの値はバッファリングの推奨サイズなので、端末デバイスの場合、この数値はあまり意味をなさない。  
  
次にDeviceの値が違うこと。  
これが重要で、1つ目の数値はファイルシステムを区別する。  
前者の場合は0なので、devptsファイルシステムに作成されており、後者はext4ファイルシステムを管理するブロックデバイスになっている。  
カーネルにとって、デバイスの実体とユーザー空間のdevpts管理が紐付いていないため、この１は動作せず入力/出力エラーになってしまうということのようだ。  
  
  
最後にハードリンクではなく、コピーしたファイルなので、Inodeは違う。  
この２つは全く別のファイルであるということだ。  
  
  
### rmコマンド  
```  
$ sudo rm /dev/pts/1  
[sudo] taichi84 のパスワード:   
rm: '/dev/pts/1' を削除できません: 許可されていない操作です  
```  
  
mvのところでもやったが、/dev/pts/1は削除できない。  
端末ファイルはdevptsファイルシステムにまとめられているが、このファイルの削除はカーネル以外にはできない仕様になっているに違いない。  
端末ファイルはあくまでカーネルの支配下にあるということだろう。  
  
  
## デバイスファイルに対するディレクトリ操作のまとめ  
ディレクトリ操作はファイルシステムの管理領域に影響するが、ドライバとの結びつきには直接作用できない。  
