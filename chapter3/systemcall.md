# 第３章で学ぶシステムコール    
  
## opendir()    
ディレクトリの内容を開く関数    
  
### 形式    
  
  
```    
#include<dirent.h>    
  
DIR *opendir(const char *name);    
  
```    
  
### 引数    
name : 開きたいディレクトリのパス    
  
### 戻り値    
成功時:DIR * 型のポインタ(readdir()等で使う)    
失敗 :NULL(例：存在しないパス、ディレクトリでないパス、権限がないなど)    
  
### 特徴    
opendir()はopen()と違い、ディレクトリ専用のハンドル(ディレクトリ専用のファイルディスクリプタのような構造のハンドル)を返します。    
readdir()を使うことで、DIR* ハンドル（から中身(ファイル名)を１件ずつ取得できます。    
読み取り中にディレクトリ構造が変わると、未定義動作になります。    
  
## readdir()    
opendir()で開いたディレクトリから１件ずつエントリを読み取る関数    
  
### 形式    
  
```    
#include<dirent.h>    
  
struct dirent *readdir(DIR *dirp);    
  
```    
  
### 引数    
dirp : opendir()によって得られたDIR * ポインタ    
  
### 戻り値    
成功 : 次のディレクトリエントリへのポインタ(struct dirent *)    
終端 :(全て読み終えたとき) NULL    
エラー時 : NULL(errnoをチェックすることで区別可能)    
  
### direntに関して    
戻り値であるディレクトリエントリの内容を理解する必要がある。    
ディレクトリエントリの内容は以下の通り。    
  
```    
struct dirent {    
    ino_t          d_ino;       // inode番号    
    off_t          d_off;       // 次のdirentへのオフセット（無視可）    
    unsigned short d_reclen;    // 構造体の長さ    
    unsigned char  d_type;      // ファイルの種類（DT_REGなど）    
    char           d_name[];    // NULL終端のファイル名（最大255文字）    
};    
  
```    
  
### direntのファイルの種類(d_type)の例    
  
| 値            | 意味                    |  
| ------------ | --------------------- |  
| `DT_REG`     | 通常のファイル               |  
| `DT_DIR`     | ディレクトリ                |  
| `DT_LNK`     | シンボリックリンク             |  
| `DT_FIFO`    | 名前付きパイプ               |  
| `DT_CHR`     | キャラクタデバイス             |  
| `DT_BLK`     | ブロックデバイス              |  
| `DT_SOCK`    | ソケット                  |  
| `DT_UNKNOWN` | 不明（必要なら `stat()` で確認） |  
  
ファイルの種類を判定することで、処理の内容を変える必要がある場面も多い。    
例えばディレクトリは青く表示するなど。    
重要な内容なので覚えておく必要がある。    
  
### 特徴    
dirent構造体を返す関数である。    
システムコールのread()のように扱える。    
構造体ごとにバッファリングされたdirent()を１件ずつ返す仕組みです。    
  
## closedir()    
ディレクトリストリームを閉じる。    
  
### 形式     
  
```    
#include<dirent.h>    
  
int closedir(DIR *dirp);    
  
```    
  
### 引数    
dirp : opendir()によって得られたDIR * 型ポインタ。    
  
### 戻り値    
成功 : 0    
失敗 : -1(errnoに詳細なエラー理由がセットされる)    
  
### 内部的に何をしているのか？    
  
- DIR * 構造体に含まれるファイルディスクリプタをclose(fd)    
- malloc()されたバッファをfree()    
- 状態構造体も解放    
  
ディレクトリ読み込みに使っていた全リソースをカーネル+ユーザー空間の両方で開放する。    
  
  
## stat()  
ファイルについての情報を取得する。  
  
### 形式  
```  
#include<sys/stat.h>  
  
int result = stat(char *fname, struct stat *bufp);  
  
```  
  
### 引数  
fnama : ファイル名  
bufp  : ファイルの情報を格納するためのバッファを指すポインタ  
  
### 戻り値  
-1 : エラーの時  
0  : 成功の時  
  
  
