# プログラミング課題 3.12   
  
## 課題内容  
suid,sgid,stickyビットを正しく処理するように、ls2.cプログラムを書き換えなさい。マニュアルを読んで、可能なすべての組み合わせを処理しなさい。  
  
## suid , sgid ,stickyビットがオンになっているとそもそもどうなる仕様だったかを確認。  
  
suid,sgid,stickyビットがオンになっていると、以下のような表示になる。  
  
### suidがオンのとき  
ユーザーの実行権限があるときはsになる。  
ユーザーの実行権限がないときはSになる。  
  
### sgidがオンの時  
グループの実行権限があるときはsになる。  
グループの実行権限がないときはSになる。  
  
### stickybitがオンの時  
その他の実行権限があるときはtになる。  
その他の実行権限がないときはTになる。  
  
これをもとに3.11で修正したls2をさらに修正していく。  
  
## 修正したls2.cのコード  
  
```  
/** ls2.c  
 *  目的 : ディレクトリ( 複数の場合も含む) の内容をリストアップする。 ls-l仕様  
 *  動作 :  
 * 引数がない場合には、"."、そうでなければ引数のディレクトリに含まれるファイルを出力する。  
 *  
 */  
  
#define _DEFAULT_SOURCE  
#include <assert.h>  
#include <dirent.h> // DIR*, opendir/readdir（使っていれば）  
#include <grp.h>    // getgrgid  
#include <pwd.h>    // getpwuid  
#include <stdio.h>  
#include <stdlib.h>  
#include <string.h>  
#include <sys/stat.h>  // struct stat  
#include <sys/types.h> // mode_t, uid_t, gid_t  
#include <time.h>      // struct timespec, localtime, strftime  
#include <unistd.h>    // close など（必要なら）  
  
void showtime(struct timespec *time);  
void mode_to_letter(mode_t mode, char str[]);  
char *uid_to_name(uid_t uid);  
char *gid_to_name(gid_t gid);  
void do_ls(char[]);  
void showstats(char *d_name);  
int main(int ac, char *av[]) {  
  if (ac == 1) {  
    do_ls(".");  
  } else {  
    while (--ac) {  
      printf("%s:\n", *++av);  
      do_ls(*av);  
    }  
  }  
  return 0;  
}  
  
void do_ls(char dirname[])  
/*  
 *  dirnameというディレクトリのファイルをリストアップする。  
 */  
{  
  DIR *dir_ptr;  
  struct dirent *direntp;  
  char buf[256];  
  
  if ((dir_ptr = opendir(dirname)) == NULL)  
    fprintf(stderr, "ls1: cannot open %s \n", dirname);  
  else {  
    while ((direntp = readdir(dir_ptr)) != NULL) {  
      if (direntp->d_name[0] == '.')  
        continue;  
      strcpy(buf, dirname);  
      strcat(buf, "/");  
      strcat(buf, direntp->d_name);  
      showstats(buf);  
      printf("\n");  
    }  
    closedir(dir_ptr);  
  }  
}  
  
void showstats(char *filename) {  
  struct stat buf;  
  struct stat *bufp = &buf;  
  char modebuf[11];  
  
  if (stat(filename, bufp) == 0) {  
    mode_to_letter(bufp->st_mode, modebuf);  
    printf("%10s ", modebuf);  
    printf("%2ld ", bufp->st_nlink);  
    printf("%10s ", uid_to_name(bufp->st_uid));  
    printf("%10s ", gid_to_name(bufp->st_gid));  
    printf("%10ld bytes   ", bufp->st_size);  
    showtime(&bufp->st_mtim);  
    printf("%20s ", strrchr(filename, '/') + 1);  
  } else {  
    printf("Can't stat %s ", filename);  
  }  
}  
  
void showtime(struct timespec *time) {  
  char *timebuf;  
  timebuf = ctime(&time->tv_sec);  
  strtok(timebuf, "\n");  
  printf("%s", timebuf);  
}  
void mode_to_letter(mode_t mode, char str[]) {  
  strcpy(str, "----------");  
  
  if (S_ISDIR(mode))  
    str[0] = 'd';  
  if (S_ISLNK(mode))  
    str[0] = 'l';  
  if (S_ISCHR(mode))  
    str[0] = 'c';  
  if (S_ISBLK(mode))  
    str[0] = 'b';  
  if (S_ISFIFO(mode))  
    str[0] = 'p';  
  if (S_ISSOCK(mode))  
    str[0] = 's';  
  
  if (mode & S_IRUSR)  
    str[1] = 'r';  
  if (mode & S_IWUSR)  
    str[2] = 'w';  
  if (mode & S_IXUSR)  
    str[3] = 'x';  
  if (mode & S_IXUSR && mode & S_ISUID)  
    str[3] = 's';  
  if ((mode & S_IXUSR) == 0 && mode & S_ISUID)  
    str[3] = 'S';  
  
  if (mode & S_IRGRP)  
    str[4] = 'r';  
  if (mode & S_IWGRP)  
    str[5] = 'w';  
  if (mode & S_IXGRP)  
    str[6] = 'x';  
  if (mode & S_IXGRP && mode & S_ISGID)  
    str[6] = 's';  
  if ((mode & S_IXGRP) == 0 && mode & S_ISGID)  
    str[6] = 'S';  
  
  if (mode & S_IROTH)  
    str[7] = 'r';  
  if (mode & S_IWOTH)  
    str[8] = 'w';  
  if (mode & S_IXOTH)  
    str[9] = 'x';  
  if (mode & S_ISVTX && mode & S_IXOTH)  
    str[9] = 't';  
  if ((mode & S_IXOTH) == 0 && mode & S_ISVTX)  
    str[9] = 'T';  
}  
  
char *uid_to_name(uid_t uid) { return getpwuid(uid)->pw_name; }  
  
char *gid_to_name(gid_t gid) { return getgrgid(gid)->gr_name; }  
```  
  
主に修正した箇所はmode_to_letter関数の中身。  
各user , group ,otherの実行権限を判定するところに実行権限があり、特殊ビットがオンの場合、実行権限がなく、特殊ビットがオンの場合の条件を書き加えている。  
これで上手く、表示が可能なはずだ。  
  
## 実行結果を確認  
  
```  
$ chmod 1777 test  
$ ./ls2  
-rwxrwxrwt  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
$ chmod 2777 test  
$ ./ls2  
-rwxrwsrwx  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
$ chmod 4777 test  
$ ./ls2  
-rwsrwxrwx  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
$ chmod 1444 test  
$ ./ls2  
-r--r--r-T  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
$ chmod 2444 test  
$ ./ls2  
-r--r-Sr--  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
$ chmod 4444 test  
$ ./ls2  
-r-Sr--r--  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
$ chmod 7777 test  
$ ./ls2  
-rwsrwsrwt  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
$ chmod 7444 test  
$ ./ls2  
-r-Sr-Sr-T  1   taichi84   taichi84          0 bytes   Sat Aug 16 23:01:47 2025                test  
  
```  
  
各種特殊ビットと実行権限の有無を書き直しながら、動作確認。  
上手く動いているようだ。  
  
  
