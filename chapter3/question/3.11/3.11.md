# プログラミング課題 3.11  
## 課題内容  
**ls2のバグ** コマンド行引数として、ディレクトリ名が渡されたときに正しく動作するようにls2.cを書き換えなさい。  
  
  
## 最初の ls2.cのソースコード  
  
```  
/** ls2.c  
 *  目的 : ディレクトリ( 複数の場合も含む) の内容をリストアップする。 ls-l仕様  
 *  動作 :  
 * 引数がない場合には、"."、そうでなければ引数のディレクトリに含まれるファイルを出力する。  
 *  
 */  
#include <dirent.h>  
#include <grp.h>  
#include <pwd.h>  
#include <stdio.h>  
#include <string.h>  
#include <sys/stat.h>  
#include <time.h>  
  
void showtime(struct timespec *time);  
void mode_to_letter(mode_t mode, char str[]);  
char *uid_to_name(uid_t uid);  
char *gid_to_name(gid_t gid);  
void do_ls(char[]);  
void showstats(char *d_name);  
int main(int ac, char *av[]) {  
  if (ac == 1) {  
    do_ls(".");  
  } else {  
    while (--ac) {  
      printf("%s:\n ", *++av);  
      do_ls(*av);  
    }  
  }  
  return 0;  
}  
  
void do_ls(char dirname[])  
/*  
 *  dirnameというディレクトリのファイルをリストアップする。  
 */  
{  
  DIR *dir_ptr;  
  struct dirent *direntp;  
  
  if ((dir_ptr = opendir(dirname)) == NULL)  
    fprintf(stderr, "ls1: cannot open %s \n", dirname);  
  else {  
    while ((direntp = readdir(dir_ptr)) != NULL) {  
      showstats(direntp->d_name);  
      printf("\n");  
    }  
    closedir(dir_ptr);  
  }  
}  
  
void showstats(char *filename) {  
  struct stat buf;  
  struct stat *bufp = &buf;  
  char modebuf[11];  
  
  if (stat(filename, bufp) == 0) {  
    mode_to_letter(bufp->st_mode, modebuf);  
    printf("%10s ", modebuf);  
    printf("%2ld ", bufp->st_nlink);  
    printf("%10s ", uid_to_name(bufp->st_uid));  
    printf("%10s ", gid_to_name(bufp->st_gid));  
    printf("%10ld bytes   ", bufp->st_size);  
    showtime(&bufp->st_mtim);  
    printf("%20s ", filename);  
  } else {  
    printf("Can't stat %s ", filename);  
  }  
}  
  
void showtime(struct timespec *time) {  
  char *timebuf;  
  timebuf = ctime(&time->tv_sec);  
  strtok(timebuf, "\n");  
  printf("%s", timebuf);  
}  
void mode_to_letter(mode_t mode, char str[]) {  
  strcpy(str, "----------");  
  
  if (S_ISDIR(mode))  
    str[0] = 'd';  
  if (S_ISLNK(mode))  
    str[0] = 'l';  
  if (S_ISCHR(mode))  
    str[0] = 'c';  
  if (S_ISBLK(mode))  
    str[0] = 'b';  
  if (S_ISFIFO(mode))  
    str[0] = 'p';  
  if (S_ISSOCK(mode))  
    str[0] = 's';  
  
  if (mode & S_IRUSR)  
    str[1] = 'r';  
  if (mode & S_IWUSR)  
    str[2] = 'w';  
  if (mode & S_IXUSR)  
    str[3] = 'x';  
  
  if (mode & S_IRGRP)  
    str[4] = 'r';  
  if (mode & S_IWGRP)  
    str[5] = 'w';  
  if (mode & S_IXGRP)  
    str[6] = 'x';  
  
  if (mode & S_IROTH)  
    str[7] = 'r';  
  if (mode & S_IWOTH)  
    str[8] = 'w';  
  if (mode & S_IXOTH)  
    str[9] = 'x';  
}  
  
char *uid_to_name(uid_t uid) { return getpwuid(uid)->pw_name; }  
  
char *gid_to_name(gid_t gid) { return getgrgid(gid)->gr_name; }  
  
```  
  
## 正規のLSと自分の作ったls2の比較。  
  
```  
  
$ ls -l testdir  
total 0  
-rw-r--r-- 1 taichi84 taichi84 0 Aug 15 20:53 filea  
-rw-r--r-- 1 taichi84 taichi84 0 Aug 15 20:53 fileb  
-rw-r--r-- 1 taichi84 taichi84 0 Aug 15 20:53 filec  
  
$ ./ls2 testdir  
testdir:  
 Can't stat filea   
Can't stat fileb   
Can't stat filec   
drwxr-xr-x  4   taichi84   taichi84       4096 bytes   Sun Aug 10 00:15:25 2025                  ..   
drwxr-xr-x  3   taichi84   taichi84       4096 bytes   Fri Aug 15 20:51:54 2025                   .   
  
```  
  
ls -l の動きはディレクトリをlsした場合、ディレクトリの中身のファイルを表示する。  
.と..に関しては表示しない。  
  
自作のls2.cはディレクトリの中身を表示してはいるようだが、中身のファイルをstatできていないようだ。  
.と..に関しても表示が行われている。  
  
### なぜディレクトリが選択された場合に中身がstatできないのか？  
考えられるのはディレクトリを選択した場合、ちゃんと現在の実行ファイルの位置からの相対パスになっていない可能性が考えられる。  
printfでdirentp->d_nameのファイル名を確認してみる。  
  
```  
  
$ ./ls2 testdir  
testdir:  
 filea   
Can't stat filea   
fileb   
Can't stat fileb   
filec   
Can't stat filec   
..   
  
```  
  
実行ファイルはtestdirの中に入っているのにファイル名は filea fileb filec のままなので、実行ファイルはtestdirの外にあるfilea fileb filec をstatsしようとしている。  
当然そのようなファイルはないのでCan't stat filea などのエラーが表示される。  
  
どのように対処すればいいか？  
  
### ファイル名にディレクトリの名前を付け足す。  
  
do_ls関数の10行目あたりからを以下のように書き換え  
  
```  
  
  if ((dir_ptr = opendir(dirname)) == NULL)  
    fprintf(stderr, "ls1: cannot open %s \n", dirname);  
  else {  
    while ((direntp = readdir(dir_ptr)) != NULL) {  
      printf("%s\n", buf);  
      strcpy(buf, dirname);  
      strcat(buf, "/");  
      strcat(buf, direntp->d_name);  
      showstats(buf);  
      printf("\n");  
    }  
  
```  
  
ディレクトリ名/ファイル名という形に変更した結果以下のように動いた。  
  
```  
$ ./ls2 testdir  
testdir:  
   
-rw-r--r--  1   taichi84   taichi84          0 bytes   Fri Aug 15 21:19:01 2025       testdir/filea   
testdir/filea  
-rw-r--r--  1   taichi84   taichi84          0 bytes   Fri Aug 15 21:19:03 2025       testdir/fileb   
testdir/fileb  
-rw-r--r--  1   taichi84   taichi84          0 bytes   Fri Aug 15 21:19:05 2025       testdir/filec   
testdir/filec  
drwxr-xr-x  3   taichi84   taichi84       4096 bytes   Fri Aug 15 21:52:01 2025          testdir/..   
testdir/..  
drwxr-xr-x  2   taichi84   taichi84       4096 bytes   Fri Aug 15 21:19:05 2025           testdir/.   
```  
  
fileaの中身はstatsできるようになった。  
あとの条件は実際に表示するときはtestdir/を消すことと、..と.を表示させないことだ。  
  
```  
  
  if ((dir_ptr = opendir(dirname)) == NULL)  
    fprintf(stderr, "ls1: cannot open %s \n", dirname);  
  else {  
    while ((direntp = readdir(dir_ptr)) != NULL) {  
      if (direntp->d_name[0] == '.')  
        continue;  
      strcpy(buf, dirname);  
      strcat(buf, "/");  
      strcat(buf, direntp->d_name);  
      showstats(buf);  
      printf("\n");  
  
```  
  
 if(direntp->d_name[0] == '.')  
    continue;  
  
によりファイル名の最初が.で始まるケースはループを飛ばすようにした。  
これで隠しファイルや.で始まるファイルは表示されなくなった。  
  
```  
$ ./ls2 testdir  
testdir:  
-rw-r--r--  1   taichi84   taichi84          0 bytes   Fri Aug 15 21:19:01 2025       testdir/filea   
-rw-r--r--  1   taichi84   taichi84          0 bytes   Fri Aug 15 21:19:03 2025       testdir/fileb   
-rw-r--r--  1   taichi84   taichi84          0 bytes   Fri Aug 15 21:19:05 2025       testdir/filec   
  
```  
  
これでファイルの中身だけ表示されるようになった。  
あとは表示時にtestdir/を削るだけだ。  
  
showstats関数ないでファイル名を表示している部分を  
strrchr関数で切り取るようにして、そのあとファイルポインタをchar1個分だけ進めよう。  
  
```  
  
  if (stat(filename, bufp) == 0) {  
    mode_to_letter(bufp->st_mode, modebuf);  
    printf("%10s ", modebuf);  
    printf("%2ld ", bufp->st_nlink);  
    printf("%10s ", uid_to_name(bufp->st_uid));  
    printf("%10s ", gid_to_name(bufp->st_gid));  
    printf("%10ld bytes   ", bufp->st_size);  
    showtime(&bufp->st_mtim);  
    printf("%20s ", strrchr(filename, '/') + 1);  
  } else {  
    printf("Can't stat %s ", filename);  
```  
  
```  
  
$ ./ls2 testdir  
testdir:  
-rw-r--r--  1   taichi84   taichi84   0 bytes   Fri Aug 15 21:19:01 2025    filea   
-rw-r--r--  1   taichi84   taichi84   0 bytes   Fri Aug 15 21:19:03 2025    fileb   
-rw-r--r--  1   taichi84   taichi84   0 bytes   Fri Aug 15 21:19:05 2025    filec   
  
```  
  
1行目がディレクトリ名を表示するようになっていたり、各カラムの幅等の仕様の違いはあるが、  
バグといえるような部分は全て修正できた。  
  
  
  
