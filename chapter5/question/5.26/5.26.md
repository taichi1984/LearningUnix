# プログラミング課題5.26
## 課題内容
バッファリングをオフにするとパフォーマンスにどのような影響があるか。
少しずつ大きなファイルを書くプログラムを作りなさい。
例えば、16バイトずつのチャンクで書き込みを続けて2Mバイトのファイルを書く。
O_SYNCをオン/オフしてこのプログラムを試しなさい。
また、ファイルサイズや書き込みの単位を変え、これらが結果にどのような影響を与えるか調べなさい。

## 実験用プログラムを書く
```
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#define CHUNK 16
#define TARGET (2 * 1024 * 1024)
int main(void) {
  char chunk[CHUNK] = "abcdefghijklmnop";
  int written = 0;
  int fd;
  fd = open("testfile", O_WRONLY | O_CREAT, 0644);

  if (fd == -1) {
    perror("open");
    exit(1);
  }

  while (written < TARGET) {
    ssize_t w = write(fd, chunk, sizeof(chunk));
    if (w == -1) {
      perror("write");
      exit(1);
    }
    if (w != CHUNK) {
      fprintf(stderr, "partial write detected \n");
      exit(1);
    }

    written += w;
    printf("%dbyte書き込み済み\n", written);
  }

  close(fd);
}
```
以上のプログラムでCHUNKの数値を増減させたり、open時のフラグにO_SYNCを追加したりする。
何が変化するのか？

## CHUNKの数値を増やす
CHUNKの数値を増やすと１回のバッファリングの容量が大きくなる。
システムコールが呼び出される回数が減るため、処理の完了は早くなる。

## O_SYNCの有無について
O_SYNCをつけると、ファイルの書き込み速度は明らかに遅くなる。
writeシステムコールが呼び出されたあとにO_SYNCフラグの有無に関わらずカーネルが受け取ったデータはpage cacheに一時保存される。
O_SYNCなしの場合はpage cacheにデータをためて、最小回数のflushでディスクに一気に書き込むようになっているが、
O_SYNCありの場合はpage cacheにデータが来るたびにディスクに書き込みを行うようになるため、flushをシステムコールを呼び出した回数だけすることになる。
ディスクアクセスは決して早くないため、非常に書き込みが遅くなる。

## 図解

|------------------|
|  ユーザー空間    |
|------------------|
        |
        |  writeシステムコールで行われる書き込み。
        |  CHUNKが増えると１回で送るデータ量が増加、システムコールの呼び出し回数が減る。
        |
|------------------|
|    page cache　　|
|------------------|
        |　カーネルがディスクに対して行う書き込み。
        |  O_SYNCフラグありだとCHUNKごとにflushするのでシステムコールの呼び出し回数分flush
        |  O_SYNCフラグなしだとpage cacheにデータをたくさんためて最小回数のflushをするのでflush回数が少ない
        |
|------------------|
|   ディスク       |
|------------------|

## 結論
CHUNKの大きさやO_SYNCフラグの有無はかなり大きくデータの書き込み速度にかなり影響する。
特にCHUNKが小さく、O_SYNCフラグがありの場合、ディスクアクセスの回数が劇的に増加するため、非常に書き込み速度が遅くなる。


