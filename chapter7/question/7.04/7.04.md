# 研究課題7.4
## 課題内容
あなたのオフィスで人々が再入可能な形で、名前と住所をリストに追加できる方法を考えなさい。
その方法は、ハンドラが呼び出されるたびにテキストファイルの末尾に3行のデータを追加するアルゴリズムに翻訳できるか。
第５章の追加モードとlinkを使ったファイルロックについての練習問題を参考にしなさい。


## アトミックな処理について考える
第５章のlinkはアトミックな処理であり、link()の最中に割り込んでlink()がきても、
片方のlinkは保証され、もう片方のリンクがあとから実行された場合はfile existsのエラーが出るようになっていた。

writeもアトミックな処理なので、これを利用して、３行のデータを追加する際に3回writeを呼ぶのではなく
１回のwriteで３行書くようにする。
これで再入された場合でも、順序はともかくとして、レコード自体が壊れることはなくなる。

O_APPENDを使ってあとは、ファイルの末尾に追加されるようにしていこう。
O_APPENDのファイルディスクリプタのoffset調整はOPEN時ではなくwrite時に行われるためO_APPENDフラグを立てておけば
確実に今書き込まれているファイルの最後にwriteされることが保証される。

## 実際のコード
```
#define _POSIX_C_SOURCE 200809L
#include <fcntl.h>
#include <signal.h>
#include <stdatomic.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main(void) {
  void entrant();
  struct sigaction newhandler;
  newhandler.sa_handler = entrant;
  newhandler.sa_flags = SA_NODEFER;

  if (sigaction(SIGINT, &newhandler, NULL) == -1) {
    perror("sigaction");
  }

  while (1) {
    printf("処理行われてる?\n");
    pause();
  }
}

void entrant() {
  char sentence1[20] = "sentence1\n";
  char sentence2[20] = "sentence2\n";
  char sentence3[20] = "sentence3\n";

  char sentence4[80] = "";
  int len = snprintf(sentence4, sizeof(sentence4), "%s%s%s", sentence1,
                     sentence2, sentence3);

  printf("ハンドラが呼ばれました\n");
  int fd = open("testfile", O_APPEND | O_WRONLY);
  if (fd == -1) {
    perror("open");
    exit(1);
  }
  printf("writing sentences\n");
  sleep(3);
  write(fd, sentence4, len);

  if (close(fd) == -1) {
    perror("close");
    exit(2);
  }
}
```
