# プログラミング課題 2.14  
## 課題内容  
**utmpの解析** who1プログラムは、utmpファイル内の全てのエントリをリストアップする。  
そうしようと思って作ったわけではないが、utmpの内容の解析ツールとしては便利だ。  
そこで構造体に含まれる他のすべてのフィールドも表示できるようにして、who1をもっと役に立つようにしなさい。  
特に役に立つのは、ut_typeフィールドだ。また、コマンド行でファイル名を指定すると、デフォルトのutmpファイルではなく、  
それを使うようにプログラムを書き換えなさい。このツールを使えば、wtmpファイルも解析できる。  
  
## who1.cの改良  
  
utmpファイルの全ての内容を表示するように改良  
  
who1r.c  
  
```  
  
/* 全てのutmpのメンバが出るバージョン *  
 */  
  
#include <fcntl.h>  
#include <stdio.h>  
#include <stdlib.h>  
#include <sys/types.h>  
#include <unistd.h>  
#include <utmp.h>  
  
#define SHOWHOST  
void show_info(struct utmp *utbufp);  
void show_header();  
int main() {  
  struct utmp current_record;  
  int utmpfd;  
  int reclen = sizeof(current_record);  
  
  if ((utmpfd = open(UTMP_FILE, O_RDONLY)) == -1) {  
    perror(UTMP_FILE);  
    exit(1);  
  }  
  show_header();  
  while (read(utmpfd, &current_record, reclen) == reclen)  
    show_info(&current_record);  
  close(utmpfd);  
  return 0;  
}  
void show_header() {  
  printf("%-10s", "ut_type");  
  printf(" ");  
  printf("%-12s", "ut_pid");  
  printf(" ");  
  printf("%-16s", "ut_line");  
  printf(" ");  
  printf("%-16s", "ut_id");  
  printf(" ");  
  printf("%-16s", "ut_user");  
  printf(" ");  
  printf("%-12s", "ut_time");  
  printf(" ");  
  printf("%-12s", "ut_session");  
  printf(" ");  
  printf("%-12s", "tv_sec");  
  printf(" ");  
  printf("%-12s", "tv_usec");  
  printf("");  
  printf("%-10s", "ut_host");  
  printf("\n");  
}  
  
void show_info(struct utmp *utbufp) {  
  printf("%-10d", utbufp->ut_type);  
  printf(" ");  
  printf("%-12d", utbufp->ut_pid);  
  printf(" ");  
  printf("%-16s", utbufp->ut_line);  
  printf(" ");  
  printf("%-16s", utbufp->ut_id);  
  printf(" ");  
  printf("%-16s", utbufp->ut_user);  
  printf(" ");  
  printf("%-12d", utbufp->ut_time);  
  printf(" ");  
  printf("%-12d", utbufp->ut_session);  
  printf(" ");  
  printf("%-12d", utbufp->ut_tv.tv_sec);  
  printf(" ");  
  printf("%-12d", utbufp->ut_tv.tv_usec);  
  printf(" ");  
  
#ifdef SHOWHOST  
  printf("(%s)", utbufp->ut_host);  
#endif  
  printf("\n");  
}  
  
  
```  
実行結果  
```  
ut_type    ut_pid       ut_line          ut_id            ut_user          ut_time      ut_session   tv_sec       tv_usec     ut_host                                                                            2          0            ~                ~~               reboot           1754052392   0            1754052392   553985       (6.6.87.2-microsoft-standard-WSL2)  
7          913          pts/1            /1               taichi84         1754052423   395          1754052423   662149       ()  
1          53           ~                ~~               runlevel         1754052425   0            1754052425   364380       (6.6.87.2-microsoft-standard-WSL2)  
6          289          console          consLOGIN        LOGIN            1754052425   289          1754052425   365486       ()  
6          293          tty1             tty1LOGIN        LOGIN            1754052425   293          1754052425   365480       ()  
```  
  
  
全てのデータを抽出できるようにした。  
  
## ファイル指定も可能にする。  
  
```  
  
/*  
 *  utmpの全ての内容が表示されるようにし、コマンドライン引数に指定したファイルから開けるようにする。  
 */  
#include <fcntl.h>  
#include <stdio.h>  
#include <stdlib.h>  
#include <sys/types.h>  
#include <unistd.h>  
#include <utmp.h>  
  
#define SHOWHOST  
void show_info(struct utmp *utbufp);  
void show_header();  
  
int main(int argc, char *argv[]) {  
  struct utmp current_record;  
  int utmpfd;  
  int reclen = sizeof(current_record);  
  
  if (argc == 2) {  
    if ((utmpfd = open(argv[1], O_RDONLY)) == -1) {  
      perror(argv[1]);  
      exit(1);  
    }  
  } else {  
    if ((utmpfd = open(UTMP_FILE, O_RDONLY)) == -1) {  
      perror(UTMP_FILE);  
      exit(1);  
    }  
  }  
  show_header();  
  while (read(utmpfd, &current_record, reclen) == reclen)  
    show_info(&current_record);  
  close(utmpfd);  
  return 0;  
}  
  
void show_header() {  
  printf("%-10s", "ut_type");  
  printf(" ");  
  printf("%-12s", "ut_pid");  
  printf(" ");  
  printf("%-16s", "ut_line");  
  printf(" ");  
  printf("%-16s", "ut_id");  
  printf(" ");  
  printf("%-16s", "ut_user");  
  printf(" ");  
  printf("%-12s", "ut_time");  
  printf(" ");  
  printf("%-12s", "ut_session");  
  printf(" ");  
  printf("%-12s", "tv_sec");  
  printf(" ");  
  printf("%-12s", "tv_usec");  
  printf(" ");  
  printf("%-10s", "ut_host");  
  printf("\n");  
}  
  
void show_info(struct utmp *utbufp) {  
  printf("%-10d", utbufp->ut_type);  
  printf(" ");  
  printf("%-12d", utbufp->ut_pid);  
  printf(" ");  
  printf("%-16s", utbufp->ut_line);  
  printf(" ");  
  printf("%-16s", utbufp->ut_id);  
  printf(" ");  
  printf("%-16s", utbufp->ut_user);  
  printf(" ");  
  printf("%-12d", utbufp->ut_time);  
  printf(" ");  
  printf("%-12d", utbufp->ut_session);  
  printf(" ");  
  printf("%-12d", utbufp->ut_tv.tv_sec);  
  printf(" ");  
  printf("%-12d", utbufp->ut_tv.tv_usec);  
  printf(" ");  
  
#ifdef SHOWHOST  
  printf("(%s)", utbufp->ut_host);  
#endif  
  printf("\n");  
}  
  
```  
  
コマンドライン引数の数に応じて最初の引数をファイル名と認識してそこから開くようにした。  
  
  
```  
  
$ ./who1r /var/log/wtmp  
  
  
ut_type    ut_pid       ut_line          ut_id            ut_user          ut_time      ut_session   tv_  
sec       tv_usec      ut_host     
2          0            ~                ~~               reboot           1752339728   0            175  
2339728   406174       (6.6.87.2-microsoft-standard-WSL2)  
1          53           ~                ~~               runlevel         1752339733   0            175  
2339733   311640       (6.6.87.2-microsoft-standard-WSL2)  
5          217          tty1             tty1                              1752339733   217          175  
2339733   313186       ()  
5          215          console          cons                              1752339733   215          175  
2339733   313186       ()  
6          217          tty1             tty1LOGIN        LOGIN            1752339733   217          175  
2339733   313186       ()  
6          215          console          consLOGIN        LOGIN            1752339733   215          175  
2339733   313186       ()  
  
以下たくさんのレコード  
  
```  
  
wtmpレコードも問題なく開くのが確認できた。  
  
  
