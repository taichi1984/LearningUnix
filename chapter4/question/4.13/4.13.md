# 研究課題4.13
## 課題内容
statシステムコールは、ファイルの名前と構造体ポインタを引数とし、ファイルについての情報を構造体に書き込む。
ディレクトリ、inode、データモデルという言葉を使ってstatの仕組みを説明しなさい。
stat構造体にコピーする情報をどこで見つけるのか？

## statの仕組み
Unixのデータモデルは以下のようになっている。

- ディレクトリはファイル名からinodeを引く表になっている。
- ファイルには属性があるが、その内容はinodeに記録されている。
- inodeにはデータブロックへのポインタ（または間接ポインタなど）が格納されており、そこに実際のデータがある。

statは、引数で取得したディレクトリのパスからディレクトリエントリを探し、inodeの番号を取得する。
そのinode該当のinodeの内容を確認し、ファイルについての基本的な情報を取得する。



### inodeにはどのような内容の情報が含まれているのか？
inode構造体を確認するとメンバは以下の通り

- i_mode
ファイルのモードを格納するメンバ。

- i_uid
所有者のユーザーID

- i_gid
所有グループのID

- i_ino
inode番号

- i_nlink( __i_nlink)
ハードリンクの数

- i_rdev
デバイスID

- i_size
ファイルサイズ

- i_atime_sec
access timeの秒

- i_mtime_sec
modify_timeの秒

- i_ctime_nsec
change timeの秒

- i_atime_nsec
access_timeのナノ秒

- i_mtime_nsec
modiry_timeのナノ秒

- i_ctime_nsec
change timeのナノ秒

- i_blocks
割り当てられたブロック数

- その他いろいろ
inodeには他にも幾つかのメンバがあるが省略する。
statで情報を取得する分には以上の内容で充分だ。

### stat構造体の定義

```
struct stat {
    dev_t     st_dev;     /* デバイス番号 */
    ino_t     st_ino;     /* iノード番号 */
    mode_t    st_mode;    /* ファイルの種類とパーミッション */
    nlink_t   st_nlink;   /* ハードリンクの数 */
    uid_t     st_uid;     /* 所有者のユーザID */
    gid_t     st_gid;     /* 所有者のグループID */
    dev_t     st_rdev;    /* デバイスID（特殊ファイル用） */
    off_t     st_size;    /* ファイルサイズ（バイト単位） */
    blksize_t st_blksize; /* 最適ブロックサイズ（I/O単位） */
    blkcnt_t  st_blocks;  /* 割り当てられたブロック数 */

    struct timespec st_atim;  /* 最終アクセス時刻 */
    struct timespec st_mtim;  /* 最終修正時刻 */
    struct timespec st_ctim;  /* 最終状態変更時刻 */

    /* glibc では別名のマクロもある */
    #define st_atime st_atim.tv_sec
    #define st_mtime st_mtim.tv_sec
    #define st_ctime st_ctim.tv_sec
};
```

上記のstat構造体の内容は st_blksize以外のメンバは全てinodeにある情報から取得することができる。

### st_blksizeメンバ
これは、そのファイルに対して推奨されるI/Oの転送単位（つまりバッファの大きさ)を示す。
これはinodeに保存されるものではなく、ファイルシステム実装ごとに計算されるか決め打ちされる値でstat()の時に設定される。

- ext4なら通常4096バイト
- NFSならマウントオプションや実装に依存
- デバイスファイルならカーネル側で別途決め打ち

などです。



