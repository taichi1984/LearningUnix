# 研究課題2.4    
    
## 課題内容    
標準Cファイル関数のfopen,getc,fclose,fgetsは、どれもバッファリングされたファイル入出力のためのシステムの一部になっている。これらの関数は、FILE型の構造体を使って、utmplibモジュールが提供していたのと同じような媒介レイヤを提供する。ヘッダファイルでFILE構造体の定義を探し、構造体メンバを説明するとともに、utmplib.cに含まれている変数と比較しなさい。    
    
## 前提知識として    
    
- fopen ファイルをオープンするための関数。ファイルポインタを返す。    
- getc １文字取得のための関数。ファイルポインタを引数として取り、現在位置のポインタから１文字返す関数。    
- fgets 複数の文字列を取得する関数。格納する変数、格納する文字数、ファイルポインタを引数に取る。    
- fclose ファイルポインタを閉じるための関数。    
    
## FILE型の構造体の定義を確認する。    
構造体を探してchatgptでメンバのコメントを訳した内容は以下の通り。    
    
| メンバ名              | 型                    | 意味・役割                                         |
| ----------------- | -------------------- | --------------------------------------------- |
| `_flags`          | `int`                | 上位ビットは `_IO_MAGIC`（識別用）、下位ビットは状態フラグ（EOF・エラー等） |
| `_IO_read_ptr`    | `char*`              | 現在の読み込み位置                                     |
| `_IO_read_end`    | `char*`              | 読み込みバッファの末尾                                   |
| `_IO_read_base`   | `char*`              | 読み込み/巻き戻し領域の開始位置                              |
| `_IO_write_base`  | `char*`              | 書き込みバッファの開始位置                                 |
| `_IO_write_ptr`   | `char*`              | 現在の書き込み位置                                     |
| `_IO_write_end`   | `char*`              | 書き込みバッファの末尾                                   |
| `_IO_buf_base`    | `char*`              | バッファ全体の開始位置                                   |
| `_IO_buf_end`     | `char*`              | バッファ全体の末尾                                     |
| `_IO_save_base`   | `char*`              | 非現在読み取り領域の開始                                  |
| `_IO_backup_base` | `char*`              | 巻き戻し領域の開始                                     |
| `_IO_save_end`    | `char*`              | 非現在読み取り領域の終了                                  |
| `_markers`        | `struct _IO_marker*` | マーク用の構造体へのポインタ（ftellなど）                       |
| `_chain`          | `_IO_FILE*`          | FILE構造体の連結（複数FILEの管理）                         |
| `_fileno`         | `int`                | OSのファイルディスクリプタ番号                              |
| `_flags2`         | `int`                | 拡張用の追加フラグ                                     |
| `_old_offset`     | `__off_t`            | 古いオフセット（seek位置）                               |
| `_cur_column`     | `unsigned short`     | 現在の出力列番号（ターミナル用）                              |
| `_vtable_offset`  | `signed char`        | 仮想関数テーブルのオフセット（C++向け）                         |
| `_shortbuf[1]`    | `char`               | 小さいバッファ（主に高速化用）                               |
| `_lock`           | `_IO_lock_t*`        | マルチスレッド向けロック                                  |
    
## utmplib.cの構造体メンバ    
    
#define NRECS   16    
#define NULLUT  ((struct utmp *)NULL)    
#define UTSIZE  (sizeof(struct utmp))    
    
static char utmpbuf[NRECS * UTSIZE];  // メモリ領域、NRECS個の構造体を一次保存するバッファ    
static int num_recs;  //格納してある個数    
static int cur_rec;   // 次のレコード番号    
static int fd_utmp = -1;  //読み出し先    
    
    
## 内容比較    
utmplib.cには現在位置のポインタと、レコード格納個数、次のレコード番号、メモリ領域などしかない。    
    
FILE構造体のメンバにはかなりたくさんの内容があるようだ。    
読み込み先と書き込み先でポインタは分割されており、読み込み先や書き込み先ファイルの先頭、末尾に置いてあるポインタも存在する模様。    
    
    
