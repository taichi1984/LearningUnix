# プログラミング課題7.13
## 課題内容
**自動ログアウト** リモートマシンに接続して、ログアウトするのを忘れたことはないだろうか。
バックグラウンドで実行され、指定された時間がすぎると、ログインシェルにSIGKILLシグナルを送るプログラムがあれば便利ではないだろうか。

(a)コマンド行引数として、プロセスIDと秒数を受け付けるtimeout.cプログラムを書きなさい。
このプログラムは、指定された秒数だけ眠ってから、指定されたプロセスIDにSIGKILLを送る。
このプログラムは、ログインシェルからtimeout $$ 3600 & という形で起動できる。 $$は、シェルのプロセスIDを表す。

(b) timeout.cの難点は、あなたがまだ作業している場合でも１時間後にはあなたをログアウトさせてしまうことである。
そこで、１０分以上あなたのttyで入出力が行われていないときに限り、あなたをログアウトさせるようにプログラムを書き換えなさい。
（ヒント：/dev/ttyxxの最終更新日時は、そのデバイスでデータが読み書きされた最後の日時を表している。
引数としてtty名を受け付けるようにプログラムを書き換えなさい。

## (a)のプログラム
純粋に指定された時間をスリープさせて指定されたpidにSIGKILLを送る。

```
#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/time.h>

#include <unistd.h>

int main(int ac, char *av[]) {

  int pid;
  int time;

  if (ac != 3) {
    fprintf(stderr, "usage : timeout pid time\n");
    exit(1);
  }

  pid = atoi(av[1]);
  time = atoi(av[2]);

  sleep(time);

  kill(pid, SIGKILL);

  return 0;
}
```

## (b)のプログラム
指定された端末（bashのPIDで指定）の内容をstatで確認し、
更新時間と現在時刻を比較し、２０秒以上たっていたら、指定されたpid(bashのpid）をSIGKILLする。
一定の時間以上立っていない場合は、２０秒以内に操作されている旨を表示し、正常終了。

テストの簡単にするため、直近どれぐらいの時間操作されているかは１０分ではなく２０秒に変更した。

```
#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <sys/time.h>
#include <time.h>
#include <unistd.h>

int timespec_diff_sec(const struct timespec *a, const struct timespec *b) {
  return a->tv_sec - b->tv_sec;
}

int main(int ac, char *av[]) {

  int pid;
  int time;
  struct stat st;
  struct timespec now;

  if (ac != 3) {
    fprintf(stderr, "usage : timeout pid time\n");
    exit(1);
  }

  pid = atoi(av[1]);
  time = atoi(av[2]);

  char path[64];
  char buf[256];

  snprintf(path, sizeof(path), "/proc/%d/fd/0", pid);
  ssize_t len = readlink(path, buf, sizeof(buf) - 1);
  if (len < 0) {
    perror("readlink");
    exit(1);
  }

  buf[len] = '\0';

  sleep(time);
  stat(buf, &st);
  clock_gettime(CLOCK_REALTIME, &now);

  if (timespec_diff_sec(&now, &st.st_atim) > 20) {
    printf("20秒以上操作されていないのでKILLします\n");
    kill(pid, SIGKILL);
  } else {
    printf(
        "20秒以内に操作されているので、KILLせずにプログラムを終了します。\n");
  }

  return 0;
}
```

これで正しく動いた。
