# 研究課題5.15
## 課題内容
あなたのシステムの/devディレクトリに含まれているファイルをみて、readをサポートしていないファイル、
writeをサポートしていないファイル、lseekをサポートしていないファイルを探しなさい。

## どのファイルが各システムコールをサポートしていないかあたりをつける。
### readシステムコール
デバイスから何かを読み込むシステムコールなので何かを表示するだけのデバイスは、
サポートしていない可能性が高い。
通常のディスプレイデバイスなどはサポートしていないと思われる。

### lseekシステムコール
マウスや、キーボードなどの情報が都度流れてくるだけのデバイスは特にseekなどは行っていないと思われる。

### writeシステムコール
キーボードやマウスなどは特にプログラムから物理的に動かす構造などを持たないため、
writeシステムコールはサポートしていない可能性が高い。


## 各デバイスに合わせてシステムコールを実際に読んでみる。
サポートしていないシステムコールを呼ばれたらエラーを返すはずだ。
以下のコードを実行し、システムコールの対応状況を確認することにした。

```

#include <errno.h>
#include <fcntl.h>
#include <linux/input.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

int main(void) {

  char *pathlist[3] = {
      "/dev/input/mouse0", // mouse0
      "/dev/dri/card1",    // ディスプレイ
      "/dev/input/event6", // キーボード
  };

  for (int i = 0; i < 3; i++) {
    printf("%s \n", pathlist[i]);
    fflush(stdout);
    int fd = open(pathlist[i], O_RDWR | O_NONBLOCK);
    if (fd == -1) {
      perror("open");
      return 1;
    }

    char buf[1000] = "test";

    if (read(fd, buf, sizeof(struct input_event)) == -1)
      printf("read: %s\n", strerror(errno));
    else
      printf("read: success\n");

    if (write(fd, buf, sizeof(buf)) == -1)
      printf("write: %s\n", strerror(errno));
    else
      printf("write: success\n");

    if (lseek(fd, 0, SEEK_SET) == -1)
      printf("lseek: %s\n", strerror(errno));
    else
      printf("lseek: success\n");

    close(fd);
  }

  return 0;
}

```

実際に実行すると以下のようになる。

```

$ gcc -o checksys checksys.c
$ sudo ./checksys
/dev/input/mouse0 
read: Resource temporarily unavailable
write: success
lseek: Illegal seek
/dev/dri/card1 
read: Resource temporarily unavailable
write: Invalid argument
lseek: success
/dev/input/event6 
read: Resource temporarily unavailable
write: success
lseek: Illegal seek

```

O_NONBLOCKで実行しているため、Resource temporaly unavailableエラーはシステムコールは受け付けているがデータがすぐきていないため、エラーを返しているだけである。

### マウスについて
マウスはreadとwriteを受付ている。（ゲーミングマウスのため、おそらく設定の反映などでマウス側にもデータを送れるようになっている。）
lseekはサポートしていないファイルである。

### ディスプレイについて
ディスプレイに関しては上のはDRMといってディスプレイとGPUの制御デバイスのため、readで状態イベントを取得ができる。
writeに関しては使えないようになっており、ioctlで描画などの処理は行われている。
lseekに関しては実はDRMの仕様だとダミーらしい。
これがwriteをサポートしてないファイルになる。

### キーボードについて
readは当然受け付けている。
writeも実は受け付けておりcapslockなどのLEDの点灯などはPC側から操作できる内容になっている。
つまりwriteも普通に受け付けている。
これはlseekをサポートしていないファイルになる。

## システムコール受付の実態
readとwriteとlseekを受け付けるかどうかに関してはデバイスによって内容が変わってくるが、
一見writeを受け付けることがなさそうなキーボードやマウスなどのデバイスも設定の変更などで使われていることがある。
が、やはりデバイスごとにこれらの意味することは変わるというのは間違いなさそうだ。


## readをサポートしていないファイルはあるのか？
ある。
/dev/snd/controlC0（ALSA のコントロールデバイス）はreadをサポートしていない。
制御用のデバイスはioctlだけを受け付け、readが実装されていないケースもある。


