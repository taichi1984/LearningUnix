# 研究課題 2.6

## 課題内容
**同じファイルの複数回オープン**  Unixは、多くのプロセスが同時に同じファイルをオープンすることを認める。
Unixは、１つのプロセスが同じファイルを複数回オープンすることも認める。ランダムなテキストが入っているファイルを作り、次の事を実行するプログラムを書いて、
同じファイルを複数回オープンすることを試しなさい。

1. ファイルを読み出し用でオープンする。
2. 同じファイルを書き込み用でオープンする。
3.同じファイルを読み出し用でさらにオープンする。

これで３個のファイルディスクリプタを持つことになっているはずだ。このプログラムは次のことができるはずである。

4. 最初のfdを使って20バイトを読み出し、出力する。
5. 第２のfdを使って、"testing 123..."という文字列を書き込む。
6. 第３のfdを使って、20バイト読み出し、出力する。

## 実際にこのプログラムを書いてみる。
### 1,2,3を実行するプログラム

```
/* c */ 

#include<stdio.h>
#include<fcntl.h>
#include<unistd.h>
#include<stdlib.h>

int main()
{
  int fd1;
  int fd2;
  int fd3;

  if((fd1 = open("samplefile.txt",O_RDONLY)) == -1){
      perror("error");
      exit(1);
  }


  if((fd2 = open("samplefile.txt",O_WRONLY)) == -1){
      perror("error");
      exit(1);
  }

  if((fd3 = open("samplefile.txt",O_RDWR)) == -1){
      perror("error");
      exit(1);
  }

  


}
```

これをコンパイル、実行した時点では特にエラーは出ない。問題なく開けているようだ。

### 4,5,6を実行したものを追加。

```

#include<stdio.h>
#include<fcntl.h>
#include<unistd.h>
#include<stdlib.h>

int main()
{
  int fd1;
  int fd2;
  int fd3;
  
  int qty = 20;

  char *buf;
  char *writing_buf = "I want write this sentence";
  buf = malloc(qty);
  
  if((fd1 = open("samplefile.txt",O_RDONLY)) == -1){
      perror("error");
      exit(1);
  }


  if((fd2 = open("samplefile.txt",O_WRONLY)) == -1){
      perror("error");
      exit(1);
  }

  if((fd3 = open("samplefile.txt",O_RDWR)) == -1){
      perror("error");
      exit(1);
  }
 
 /*4の処理*/
  if(read(fd1,buf,qty) != -1)
  {
    printf("%s \n",buf);
  }

  if(write(fd2,writing_buf,qty) != -1)
  {
    printf("書き込み完了\n");

  }
  
  
  if(read(fd3,buf,qty) != -1)
  {
    printf("%s \n",buf);
  }

  close(fd1);
  close(fd2);
  close(fd3);
  free(buf);

  
}
```

```
実行結果

The quick brown fox
書き込み完了
I want write this se

```

問題なく読み出し、書き込みができている。

## 学び
unixシステムはファイルを開いた時に基本的にファイルをロックしないので、複数のユーザーでファイルをオープンすることができるし、同時に、編集することも可能。

同時に同じファイルにアクセスすると競合が発生して、ファイルが壊れてしまう可能性があるので、同時に編集する可能性があるような状況では、上手くマージできるようにするシステムや、編集の衝突を検知するシステムなどファイルを守るような作りは必須になる。


