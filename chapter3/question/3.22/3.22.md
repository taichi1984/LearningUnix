# プログラミング課題3.22  
## 課題内容  
端末デバイスは、プログラムがあなたからデータを受け取り、あなたにデータを送り出すために使うファイルである。  
プログラムが端末デバイスから読み出す場合には、キーボードからデータを読み出す。  
プログラムが端末デバイスに書き込むときには、ディスプレイにデータを送る。  
端末ファイルのst_mtimeの設定は、端末デバイスに最後に書き込みをした日時を表す。  
ログインしている全てのユーザーのリストを表示するとともに、ここのユーザーについて、端末を最後に書き換えた日時を表示する  
lastdataというプログラムを書きなさい。whoと同じ表示形式に従うこと。  
  
  
## ログインしている全てのユーザーのリストを表示するにはどうすればいいか？  
  
### そもそもログインしているユーザーとは？  
utmpファイルから、ログインしているであろうユーザーの情報を取得すればわかるが、  
このユーザーの中で、ログインしているユーザーとはどういったエントリの事を指すのか？  
  
⇒　utmp構造体の中でut_typeがUSER_PROCESSであるエントリがログインしているユーザーになる。  
  
  
### 設計案  
UTMPファイルをオープンする。  
↓  
utmp構造体を１件ずつ読み、"/dev/" のあとにut_lineメンバを文字連結することにより、端末ファイルのパスを取得  
↓  
端末ファイルのパスをstatし、そのファイルのst_mtimを取得する。  
↓  
取得したst_mtimをstrftime関数を使って人間が読める形(time_s)に変更  
↓  
ut_user  ut_line  time_sという形で表示  
↓  
次のエントリを読みにいき繰り返す。  
↓  
全件終わったらUTMPファイルをオープンしたfdをcloseする。  
  
これで実現できるはず。  
  
## ソースコード  
  
```  
  
#define _POSIX_C_SOURCE 200809L  
#include <fcntl.h>  
#include <stdio.h>  
#include <sys/stat.h>  
#include <sys/types.h>  
#include <time.h>  
#include <unistd.h>  
#include <utmp.h>  
  
int main(void) {  
  struct utmp user;  
  struct stat userstat;  
  char buf[512];  
  int fd = 0;  
  int i = 0;  
  
  if ((fd = open(UTMP_FILE, O_RDONLY)) == -1) {  
    perror("open");  
    return 1;  
  }  
  
  while (read(fd, &user, sizeof(struct utmp))) {  
  
    if (user.ut_type == USER_PROCESS) {  
      snprintf(buf, sizeof(buf), "/dev/%s", user.ut_line);  
  
      if (stat(buf, &userstat) == -1) {  
        perror("stat");  
      }  
      char time_s[512];  
      time_t t = userstat.st_mtim.tv_sec;  
      struct tm *lt = localtime(&t);  
  
      strftime(time_s, sizeof(time_s), "%Y-%m-%d %H:%M:%S", lt);  
  
      printf("%-10s  %-5s   ", user.ut_user, user.ut_line);  
      printf("%s \n", time_s);  
    }  
    i++;  
  }  
  
  if (close(fd) == -1) {  
    perror("close");  
    return 1;  
  }  
}  
```  
  
## 実行結果  
```  
$ lastdata  
taichi84    pts/1   2025-09-04 22:15:24   
```  
  
  
